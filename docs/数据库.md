
# Users 集合
```js
{
  _id: ObjectId,          // 用户唯一ID
  username: String,       // 用户名（唯一）
  passwordHash: String,   // 加密后的密码（bcrypt哈希）
  email: String,          // 邮箱（带唯一索引）
  createdAt: Date,        // 账号创建时间
}
```

# messages 集合
```js
{
  sessionId: ObjectId,    // 关联会话ID
  userId: ObjectId,       // 用户ID（冗余存储便于快速查询）
  role: {                 // 消息角色
    type: String,
    enum: ["user", "assistant"]
  },
  content: String,        // 消息内容
  model: String,          // 响应时使用的AI模型
  promptTokens: Number,   // 提示词消耗token数
  completionTokens: Number,// 响应消耗token数
  timestamp: Date         // 精确到毫秒的时间戳
}
```

# prompt_templates 集合
```js
{
  name: String,            // 模板名称
  systemPrompt: String,    // 系统角色设定文本
  contextRules: [String],  // 上下文处理规则
  maxTokens: Number,       // 最大token限制
  temperature: Number      // 生成温度参数
}
```

# api_keys 集合
```js
{
  service: {               // 服务提供商
    type: String,
    enum: ["openai", "anthropic", "gemini"]
  },
  keyHash: String,         // 加密存储的API密钥
  usage: {                 // 使用统计
    monthCalls: Number,
    monthTokens: Number
  }
}
```

# audit_logs 集合
```js
{
  userId: ObjectId,       // 操作用户（null表示系统操作）
  action: {               // 操作类型
    type: String,
    enum: ["login", "query", "status_update", "error"]
  },
  details: Object,        // 操作详情（灵活结构）
  ipAddress: String,      // 客户端IP
  timestamp: Date
}
```

erDiagram
    USERS ||--o{ USER_STATES : "1:1"
    USERS ||--o{ SESSIONS : "1:N"
    SESSIONS ||--o{ MESSAGES : "1:N"
    PROMPT_TEMPLATES ||--o{ SESSIONS : "应用到"
    API_KEYS ||--o{ MESSAGES : "用于请求"